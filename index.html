<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقه دانش</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* پالت رنگی */
            --primary-color: #4a90e2;   /* آبی اصلی */
            --secondary-color: #8c8c8c; /* خاکستری برای متن ثانویه */
            --background-light: #f5f8fa; /* پس زمینه روشن */
            --background-card: #ffffff; /* پس زمینه کارت ها */
            --text-dark: #333333;       /* متن تیره */
            --border-color: #e0e0e0;    /* رنگ border */
            --success-color: #5cb85c;   /* سبز موفقیت */
            --error-color: #d9534f;     /* قرمز خطا */
            --shadow-light: rgba(0, 0, 0, 0.08); /* سایه روشن */
            --fifty-fifty-color: #ffc107; /* رنگ برای دکمه 50-50 */
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-dark);
            line-height: 1.6;
        }
        .container {
            background-color: var(--background-card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-light);
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            box-sizing: border-box; /* اطمینان از اینکه padding بر روی عرض تاثیر نگذارد */
        }
        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
        }
        p {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 20px;
        }
        .user-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 1.1em;
        }
        .user-input input[type="text"] {
            width: calc(100% - 24px); /* کمی فاصله برای padding */
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.05em;
            color: var(--text-dark);
            transition: border-color 0.3s ease;
        }
        .user-input input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .user-input button, .quiz-controls button {
            background-color: var(--primary-color);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        .user-input button:hover, .quiz-controls button:hover {
            background-color: #3a7bd5; /* کمی تیره تر */
            transform: translateY(-2px);
        }
        #quiz-section {
            display: none; /* در ابتدا مخفی است */
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
            margin-top: 20px;
        }
        .question-box {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 10px var(--shadow-light);
        }
        .question-meta {
            font-size: 0.95em;
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: left; /* برای نمایش در سمت چپ */
            font-weight: 500;
        }
        .question-text {
            font-size: 1.35em;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 25px;
            text-align: right;
        }
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options-list li {
            background-color: #f0f0f0;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
            font-size: 1.1em;
            color: var(--text-dark);
            font-weight: 400;
        }
        .options-list li:hover {
            background-color: #e0e0e0;
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .options-list li.correct {
            background-color: var(--success-color); /* سبز */
            border-color: #4CAF50;
            color: white;
            font-weight: 500;
        }
        .options-list li.incorrect {
            background-color: var(--error-color); /* قرمز */
            border-color: #f44336;
            color: white;
            font-weight: 500;
        }
        .options-list li.answered {
            pointer-events: none; /* Disable clicking after an answer */
            opacity: 0.9;
        }
        /* Style for 50-50 removed options */
        .options-list li.removed {
            opacity: 0.4;
            pointer-events: none;
            background-color: #fdfdff; /* Very light, almost white */
            color: #b0b0b0;
            text-decoration: line-through;
        }
        .current-player-display {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .quiz-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        .quiz-controls label {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 5px;
            display: block;
        }
        .quiz-controls select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1.05em;
            min-width: 250px;
            background-color: var(--background-card);
            color: var(--text-dark);
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }
        .quiz-controls button#end-quiz-btn {
            background-color: var(--error-color); /* قرمز برای پایان مسابقه */
        }
        .quiz-controls button#end-quiz-btn:hover {
            background-color: #c9302c;
        }
        button#fifty-fifty-btn {
            background-color: var(--fifty-fifty-color);
            color: var(--text-dark);
        }
        button#fifty-fifty-btn:hover {
            background-color: #e0a800;
        }
        button#fifty-fifty-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            color: #666;
            transform: none;
        }
        #results-section {
            display: none;
            text-align: center;
            padding-top: 30px;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #results-section h2 {
            color: var(--success-color);
            font-weight: 700;
            margin-bottom: 30px;
        }
        #results-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        #results-list li {
            background-color: #e9f7ef; /* سبز روشن تر */
            padding: 18px 25px;
            margin-bottom: 15px;
            border-radius: 10px;
            text-align: right;
            border: 1px solid #d4edda;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            font-size: 1.1em;
            color: var(--text-dark);
        }
        #results-list li strong {
            color: var(--primary-color);
            font-size: 1.2em;
            display: block;
            margin-bottom: 8px;
        }

        /* Player scores at the bottom */
        #player-scores-display-bottom {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            gap: 15px;
        }
        .player-score-item-bottom {
            background-color: #e6f7ff;
            padding: 12px 20px;
            border-radius: 8px;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #cceeff;
        }
        .player-score-item-bottom strong {
            display: block;
            font-size: 1.2em;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        .player-score-item-bottom span {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>مسابقه بزرگ دانش</h1>

        <div id="user-input-section" class="user-input">
            <h2>ثبت نام شرکت‌کنندگان</h2>
            <p>لطفاً نام حداقل ۲ و حداکثر ۱۰ شرکت‌کننده را وارد کنید:</p>
            <div id="player-inputs">
                </div>
            <button id="add-player-btn">افزودن شرکت‌کننده</button>
            <button id="start-quiz-btn" style="margin-top: 15px;">شروع مسابقه</button>
        </div>

        <div id="quiz-section">
            <div class="current-player-display">
                <span id="current-player-name"></span>
            </div>

            <div id="questions-container">
                </div>

            <div class="quiz-controls">
                <button id="fifty-fifty-btn">۵۰-۵۰ (حذف ۲ گزینه غلط)</button>
                <label for="category-select">انتخاب دسته بندی:</label>
                <select id="category-select">
                    <option value="">همه دسته‌ها (رندوم)</option>
                </select>

                <label for="difficulty-select">انتخاب درجه سختی:</label>
                <select id="difficulty-select">
                    <option value="">همه سختی‌ها (رندوم)</option>
                    <option value="آسان">آسان</option>
                    <option value="متوسط">متوسط</option>
                    <option value="سخت">سخت</option>
                    <option value="خیلی سخت">خیلی سخت</option>
                </select>
                <button id="next-question-btn">سوال بعدی</button>
                <button id="end-quiz-btn">پایان مسابقه</button>
            </div>
            <div id="player-scores-display-bottom">
                </div>
        </div>

        <div id="results-section">
            <h2>نتایج مسابقه</h2>
            <ul id="results-list">
                </ul>
        </div>
    </div>

    <script>
        const playerInputsDiv = document.getElementById('player-inputs');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const userInputSection = document.getElementById('user-input-section');
        const quizSection = document.getElementById('quiz-section');
        const questionsContainer = document.getElementById('questions-container');
        const currentPlayerDisplay = document.getElementById('current-player-name'); // For displaying current player
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const endQuizBtn = document.getElementById('end-quiz-btn');
        const resultsSection = document.getElementById('results-section');
        const resultsList = document.getElementById('results-list');
        const categorySelect = document.getElementById('category-select');
        const difficultySelect = document.getElementById('difficulty-select');
        const fiftyFiftyBtn = document.getElementById('fifty-fifty-btn'); // 50-50 button
        const playerScoresDisplayBottom = document.getElementById('player-scores-display-bottom'); // Scores at the bottom

        let playerCount = 0;
        const maxPlayers = 10;
        const minPlayers = 2;
        let allQuestions = []; // Stores all parsed questions
        let currentQuestion = null; // Stores the currently displayed question object
        let players = {}; // Stores player names and their scores: { 'name': { score: 0, correct: 0, wrong: 0, fiftyFiftyUsed: 0 } }
        let playerNamesArray = []; // To maintain order of player names for circular turn
        let currentPlayerIndex = 0; // Index of the current player in playerNamesArray

        // امتیازدهی برای پاسخ صحیح
        const difficultyPointsCorrect = {
            'آسان': 1,
            'متوسط': 2,
            'سخت': 3,
            'خیلی سخت': 4
        };

        // امتیازدهی منفی برای پاسخ اشتباه
        const difficultyPointsIncorrect = {
            'آسان': -3,
            'متوسط': -2,
            'سخت': -1,
            'خیلی سخت': -0.5
        };

        // --- مدیریت ورود نام کاربران ---

        function addPlayerInput() {
            if (playerCount < maxPlayers) {
                playerCount++;
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'player-input-wrapper';
                inputWrapper.innerHTML = `
                    <label for="player${playerCount}">نام شرکت‌کننده ${playerCount}:</label>
                    <input type="text" id="player${playerCount}" required>
                `;
                playerInputsDiv.appendChild(inputWrapper);
            }
            if (playerCount >= maxPlayers) {
                addPlayerBtn.style.display = 'none'; // Hide add button if max players reached
            }
        }

        // Add initial players (e.g., 2 by default)
        for (let i = 0; i < minPlayers; i++) {
            addPlayerInput();
        }

        addPlayerBtn.addEventListener('click', addPlayerInput);

        startQuizBtn.addEventListener('click', () => {
            playerNamesArray = [];
            let allInputsValid = true;
            for (let i = 1; i <= playerCount; i++) {
                const input = document.getElementById(`player${i}`);
                if (input && input.value.trim() === '') {
                    allInputsValid = false;
                    input.style.borderColor = 'red'; // Highlight empty input
                } else if (input) {
                    playerNamesArray.push(input.value.trim());
                    input.style.borderColor = 'var(--border-color)'; // Reset border color
                }
            }

            if (playerNamesArray.length < minPlayers) {
                alert(`لطفاً حداقل ${minPlayers} شرکت‌کننده وارد کنید.`);
                return;
            }

            if (!allInputsValid) {
                alert('لطفاً نام تمام شرکت‌کنندگان را وارد کنید.');
                return;
            }

            // Initialize player scores and fiftyFiftyUse count
            players = {}; // Reset players object
            playerNamesArray.forEach(name => {
                players[name] = { score: 0, correct: 0, wrong: 0, fiftyFiftyUsed: 0 };
            });

            userInputSection.style.display = 'none';
            quizSection.style.display = 'block';
            loadQuestionsAndSetupQuiz();
            updatePlayerScoresDisplay(); // Display initial scores (all 0)
            updateCurrentPlayerDisplay(); // Show the first player
        });

        // --- مدیریت خواندن و نمایش سوالات ---

        async function loadQuestionsAndSetupQuiz() {
            try {
                const response = await fetch('race.txt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                allQuestions = parseQuestions(text);
                populateCategoryFilter();
                displayNextQuestion(); // Display the first question
            } catch (error) {
                console.error("Error loading or parsing questions:", error);
                questionsContainer.innerHTML = "<p>خطا در بارگذاری سوالات. لطفاً از وجود فایل race.txt در کنار این فایل اطمینان حاصل کنید.</p>";
            }
        }

        function parseQuestions(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line !== '');
            const parsedQuestions = [];
            let currentQ = {};
            let parsingOptions = false;

            for (const line of lines) {
                if (line.startsWith('درجه سختی:')) {
                    if (Object.keys(currentQ).length > 0) {
                        parsedQuestions.push(currentQ);
                    }
                    currentQ = { options: [] };
                    currentQ.difficulty = line.replace('درجه سختی:', '').trim();
                    parsingOptions = false;
                } else if (line.startsWith('دسته بندی:')) {
                    currentQ.category = line.replace('دسته بندی:', '').trim();
                } else if (line.startsWith('سوال:')) {
                    currentQ.questionText = line.replace('سوال:', '').trim().replace(/^"|"$/g, ''); // Remove quotes
                    parsingOptions = false;
                } else if (line.startsWith('گزینه ها:')) {
                    parsingOptions = true;
                    currentQ.options = [];
                } else if (parsingOptions && (line.startsWith('الف)') || line.startsWith('ب)') || line.startsWith('ج)') || line.startsWith('د)'))) {
                    currentQ.options.push(line.trim());
                } else if (line.startsWith('جواب صحیح:')) {
                    currentQ.correctAnswer = line.replace('جواب صحیح:', '').trim();
                    parsingOptions = false; // Options parsing finished for this question
                }
            }
            if (Object.keys(currentQ).length > 0) {
                parsedQuestions.push(currentQ);
            }
            return parsedQuestions;
        }

        function populateCategoryFilter() {
            const categories = new Set();
            allQuestions.forEach(q => categories.add(q.category));
            categorySelect.innerHTML = '<option value="">همه دسته‌ها (رندوم)</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        function displayNextQuestion() {
            // Re-enable 50-50 button for the new question
            if (currentQuestion && (currentQuestion.difficulty === 'سخت' || currentQuestion.difficulty === 'خیلی سخت')) {
                 fiftyFiftyBtn.disabled = false;
            } else {
                fiftyFiftyBtn.disabled = true; // Disable if not a hard question
            }
           

            // Apply filters
            const selectedCategory = categorySelect.value;
            const selectedDifficulty = difficultySelect.value;

            const filteredQuestions = allQuestions.filter(q => {
                const matchesCategory = selectedCategory === '' || q.category === selectedCategory;
                const matchesDifficulty = selectedDifficulty === '' || q.difficulty === selectedDifficulty;
                return matchesCategory && matchesDifficulty;
            });

            if (filteredQuestions.length === 0) {
                questionsContainer.innerHTML = "<p>سوالی با این فیلترها پیدا نشد. لطفاً فیلترها را تغییر دهید.</p>";
                currentQuestion = null;
                fiftyFiftyBtn.disabled = true; // Disable 50-50 if no question
                return;
            }

            // Select a random question from filtered ones
            const randomIndex = Math.floor(Math.random() * filteredQuestions.length);
            currentQuestion = filteredQuestions[randomIndex]; // Set the current question

            questionsContainer.innerHTML = ''; // Clear previous question
            const questionBox = document.createElement('div');
            questionBox.className = 'question-box';
            questionBox.innerHTML = `
                <div class="question-meta">
                    ${currentQuestion.category} - ${currentQuestion.difficulty}
                </div>
                <div class="question-text">
                    ${currentQuestion.questionText}
                </div>
                <ul class="options-list" data-difficulty="${currentQuestion.difficulty}">
                    ${currentQuestion.options.map(option => `
                        <li data-option-text="${option.substring(option.indexOf(')') + 1).trim()}" data-option-key="${option.substring(0, option.indexOf(')'))}">${option}</li>
                    `).join('')}
                </ul>
            `;
            questionsContainer.appendChild(questionBox);

            // Add event listeners to options for the *new* question
            document.querySelectorAll('.options-list li').forEach(optionLi => {
                optionLi.addEventListener('click', handleOptionClick);
            });
            // Update 50-50 button state after loading question
            updateFiftyFiftyButtonState();
        }

        function handleOptionClick(event) {
            const clickedOption = event.target;
            const optionsList = clickedOption.closest('.options-list');
            const questionDifficulty = optionsList.dataset.difficulty;

            const currentPlayerName = playerNamesArray[currentPlayerIndex];
            if (!currentPlayerName) {
                alert('خطا: کاربر فعلی یافت نشد. لطفاً مسابقه را مجدداً شروع کنید.');
                return;
            }

            // Disable all options for this question after one is clicked
            Array.from(optionsList.children).forEach(li => {
                li.classList.add('answered'); // Add a class to indicate it's answered and disable clicks
                li.removeEventListener('click', handleOptionClick); // Remove listener to prevent re-clicking
            });
            
            // Find the correct option element
            let correctOptionElement = null;
            Array.from(optionsList.children).forEach(li => {
                if (currentQuestion && li.textContent.includes(currentQuestion.correctAnswer)) {
                    correctOptionElement = li;
                }
            });

            if (clickedOption === correctOptionElement) {
                clickedOption.classList.add('correct');
                players[currentPlayerName].correct++;
                players[currentPlayerName].score += difficultyPointsCorrect[questionDifficulty];
            } else {
                clickedOption.classList.add('incorrect');
                players[currentPlayerName].wrong++;
                players[currentPlayerName].score += difficultyPointsIncorrect[questionDifficulty]; // اعمال نمره منفی
                if (correctOptionElement) {
                    correctOptionElement.classList.add('correct'); // Show the correct answer as well
                }
            }
            updatePlayerScoresDisplay();
            // Move to the next player
            currentPlayerIndex = (currentPlayerIndex + 1) % playerNamesArray.length;
            updateCurrentPlayerDisplay(); // Update display for next player
        }

        nextQuestionBtn.addEventListener('click', displayNextQuestion);
        endQuizBtn.addEventListener('click', showResults);
        fiftyFiftyBtn.addEventListener('click', handleFiftyFifty);


        // --- مدیریت امتیازات و انتخاب کاربر ---

        function updatePlayerScoresDisplay() {
            playerScoresDisplayBottom.innerHTML = '';
            playerNamesArray.forEach(name => {
                const player = players[name];
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-score-item-bottom';
                // نمایش امتیاز بدون اعشار مگر اینکه اعشار داشته باشد
                const scoreDisplay = (player.score % 1 !== 0) ? player.score.toFixed(1) : player.score;
                playerDiv.innerHTML = `
                    <strong>${name}</strong><br>
                    <span>امتیاز: ${scoreDisplay}</span>
                `;
                playerScoresDisplayBottom.appendChild(playerDiv);
            });
        }

        function updateCurrentPlayerDisplay() {
            if (playerNamesArray.length > 0) {
                currentPlayerDisplay.textContent = `نوبت: ${playerNamesArray[currentPlayerIndex]}`;
            } else {
                currentPlayerDisplay.textContent = '';
            }
        }

        // --- قابلیت 50-50 ---
        function handleFiftyFifty() {
            if (!currentQuestion) {
                alert('ابتدا یک سوال نمایش داده شود.');
                return;
            }

            const currentPlayerName = playerNamesArray[currentPlayerIndex];
            if (!currentPlayerName) {
                alert('خطا: کاربر فعلی یافت نشد. لطفاً مسابقه را مجدداً شروع کنید.');
                return;
            }

            const player = players[currentPlayerName];

            // Check if 50-50 can be used
            if (currentQuestion.difficulty !== 'سخت' && currentQuestion.difficulty !== 'خیلی سخت') {
                alert('قابلیت ۵۰-۵۰ فقط برای سوالات سخت و خیلی سخت قابل استفاده است.');
                return;
            }

            // Apply penalty for 50-50 usage
            if (player.fiftyFiftyUsed === 0) {
                player.score -= 0.5; // First time penalty
            } else {
                player.score -= 1; // Subsequent times penalty
            }
            player.fiftyFiftyUsed++;
            updatePlayerScoresDisplay(); // Update score display immediately

            // Logic to remove two incorrect options
            const optionsList = questionsContainer.querySelector('.options-list');
            const allOptions = Array.from(optionsList.children);
            const correctAnswerText = currentQuestion.correctAnswer;
            
            const incorrectOptions = allOptions.filter(li => !li.textContent.includes(correctAnswerText));
            
            // Randomly select 2 incorrect options to remove
            let removedCount = 0;
            while (removedCount < 2 && incorrectOptions.length > 0) {
                const randomIndex = Math.floor(Math.random() * incorrectOptions.length);
                const optionToRemove = incorrectOptions.splice(randomIndex, 1)[0]; // Remove and get the element
                if (optionToRemove) {
                    optionToRemove.classList.add('removed');
                    removedCount++;
                }
            }
            fiftyFiftyBtn.disabled = true; // Disable 50-50 button after use for this question
        }

        function updateFiftyFiftyButtonState() {
             if (currentQuestion && (currentQuestion.difficulty === 'سخت' || currentQuestion.difficulty === 'خیلی سخت')) {
                 fiftyFiftyBtn.disabled = false;
            } else {
                fiftyFiftyBtn.disabled = true;
            }
        }

        // --- نمایش نتایج نهایی ---
        function showResults() {
            quizSection.style.display = 'none';
            resultsSection.style.display = 'block';
            resultsList.innerHTML = '';

            // Sort players by score
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);

            sortedPlayers.forEach(([name, data]) => {
                const listItem = document.createElement('li');
                // نمایش امتیاز بدون اعشار مگر اینکه اعشار داشته باشد
                const scoreDisplay = (data.score % 1 !== 0) ? data.score.toFixed(1) : data.score;
                listItem.innerHTML = `
                    <strong>${name}:</strong>
                    <br> امتیاز کلی: ${scoreDisplay}
                    <br> پاسخ صحیح: ${data.correct}
                    <br> پاسخ غلط: ${data.wrong}
                    <br> دفعات استفاده از ۵۰-۵۰: ${data.fiftyFiftyUsed}
                `;
                resultsList.appendChild(listItem);
            });
        }

    </script>
</body>
</html>
