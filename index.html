<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقه دانش</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* پالت رنگی */
            --primary-color: #4a90e2;   /* آبی اصلی */
            --secondary-color: #8c8c8c; /* خاکستری برای متن ثانویه */
            --background-light: #f5f8fa; /* پس زمینه روشن */
            --background-card: #ffffff; /* پس زمینه کارت ها */
            --text-dark: #333333;       /* متن تیره */
            --border-color: #e0e0e0;    /* رنگ border */
            --success-color: #5cb85c;   /* سبز موفقیت */
            --error-color: #d9534f;     /* قرمز خطا */
            --shadow-light: rgba(0, 0, 0, 0.08); /* سایه روشن */
            --fifty-fifty-color: #ffc107; /* رنگ برای دکمه 50-50 */
            --tavakkol-color: #5bc0de;      /* رنگ برای دکمه توکل به خدا */
            --tavakkol-hover-color: #31b0d5; /* رنگ هاور برای دکمه توکل به خدا */
            --active-player-color: #28a745; /* رنگ برای کاربر فعال */

            /* رنگ بندی جدید برای امتیازات پایین صفحه */
            --score-bg-color: #e3f2fd; /* آبی بسیار روشن */
            --score-border-color: #90caf9; /* آبی روشن تر */
            --score-text-color: #1a237e; /* آبی تیره برای متن */
            --score-name-color: #0d47a1; /* آبی تیره تر برای نام */

            /* رنگ جدید برای دکمه‌های ذخیره/بارگذاری - سبز */
            --save-load-btn-color: #28a745; /* سبز */
            --save-load-btn-hover-color: #218838; /* سبز تیره‌تر */
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Styles for the header title */
        .page-header {
            width: 100%;
            background-color: var(--primary-color);
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 10px var(--shadow-light);
            margin-bottom: 0;
        }

        .page-header h1 {
            color: white;
            margin: 0;
            font-size: 1.8em;
        }

        .container {
            background-color: var(--background-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-light);
            width: 95%;
            max-width: 960px;
            margin: 20px auto;
            box-sizing: border-box;
        }

        h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
        }
        p {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 20px;
        }
        .user-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 1.1em;
        }
        .user-input input[type="text"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.05em;
            color: var(--text-dark);
            transition: border-color 0.3s ease;
        }
        .user-input input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .user-input button {
            background-color: var(--primary-color);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        .user-input button:hover {
            background-color: #3a7bd5;
            transform: translateY(-2px);
        }
        #quiz-section {
            display: none;
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
            margin-top: 20px;
        }
        .question-box {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 10px var(--shadow-light);
            width: 100%;
            box-sizing: border-box;
        }
        .question-meta {
            font-size: 0.95em;
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: left;
            font-weight: 500;
        }
        .question-text {
            font-size: 1.0em;
            font-weight: 400;
            color: var(--text-dark);
            margin-bottom: 25px;
            text-align: right;
        }
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options-list li {
            background-color: #f0f0f0;
            padding: 12px 18px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
            font-size: 0.95em;
            color: var(--text-dark);
            font-weight: 400;
        }
        .options-list li:hover {
            background-color: #e0e0e0;
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .options-list li.correct {
            background-color: var(--success-color);
            border-color: #4CAF50;
            color: white;
            font-weight: 500;
        }
        .options-list li.incorrect {
            background-color: var(--error-color);
            border-color: #f44336;
            color: white;
            font-weight: 500;
        }
        .options-list li.answered {
            pointer-events: none;
            opacity: 0.9;
        }
        .options-list li.removed {
            opacity: 0.4;
            pointer-events: none;
            background-color: #fdfdff;
            color: #b0b0b0;
            text-decoration: line-through;
        }
        .player-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            /* حذف border-bottom و padding-bottom */
            margin-bottom: 5px; /* کاهش بیشتر فاصله تا دکمه سوال بعدی */
        }
        .player-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .player-score-top {
            font-size: 0.75em;
            color: var(--secondary-color);
            opacity: 0.8;
            font-weight: 500;
        }
        .player-button {
            background-color: #e6f7ff;
            color: var(--primary-color);
            border: 1px solid #cceeff;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .player-button:hover {
            background-color: #cceeff;
            transform: translateY(-2px);
        }
        .player-button.active-player {
            background-color: var(--active-player-color);
            color: white;
            border-color: var(--active-player-color);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }
        .quiz-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        .quiz-controls label {
            font-size: 1.0em;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 5px;
            display: block;
        }
        /* Multiselect styles */
        .multiselect-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background-color: var(--background-card);
            width: 100%;
            box-sizing: border-box;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .multiselect-container label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-dark);
            font-weight: 400;
        }
        .multiselect-container label:last-child {
            margin-bottom: 0;
        }
        .multiselect-container input[type="checkbox"] {
            margin-left: 8px;
            transform: scale(1.1);
        }

        /* Smaller buttons for helpers and End Quiz */
        .quiz-controls button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        .quiz-controls button:hover {
            background-color: #3a7bd5;
            transform: translateY(-2px);
        }

        /* Next Question Button specific style */
        #next-question-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 500;
            display: block;
            margin: 0 auto 20px auto;
            max-width: 200px;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        #next-question-btn:hover {
            background-color: #3a7bd5;
            transform: translateY(-2px);
        }


        button#end-quiz-btn {
            background-color: var(--error-color);
        }
        button#end-quiz-btn:hover {
            background-color: #c9302c;
        }
        button#fifty-fifty-btn {
            background-color: var(--fifty-fifty-color);
            color: var(--text-dark);
            margin-bottom: 5px; /* فاصله کمتر */
        }
        button#fifty-fifty-btn:hover {
            background-color: #e0a800;
        }
        button#fifty-fifty-btn:disabled,
        button#tavakkol-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            color: #666;
            transform: none;
        }
        
        button#tavakkol-btn {
            background-color: var(--tavakkol-color);
            color: white;
        }
        
        button#tavakkol-btn:hover {
             background-color: var(--tavakkol-hover-color);
        }


        /* Save/Load buttons style */
        .save-load-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .save-load-buttons button {
            background-color: var(--save-load-btn-color); /* رنگ جدید */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            width: auto;
            flex-grow: 1;
            max-width: 150px;
        }
        .save-load-buttons button:hover {
            background-color: var(--save-load-btn-hover-color); /* رنگ هاور جدید */
        }


        #results-section {
            display: none;
            text-align: center;
            padding-top: 20px;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        #results-section h2 {
            color: var(--success-color);
            font-weight: 700;
            margin-bottom: 20px;
        }
        #results-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        #results-list li {
            background-color: #e9f7ef;
            padding: 12px 18px;
            margin-bottom: 10px;
            border-radius: 8px;
            text-align: right;
            border: 1px solid #d4edda;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            font-size: 1.0em;
            color: var(--text-dark);
        }
        #results-list li strong {
            color: var(--primary-color);
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        /* Player scores at the bottom - smaller and better color scheme */
        #player-scores-display-bottom {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }
        .player-score-item-bottom {
            background-color: var(--score-bg-color);
            padding: 8px 15px;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--score-border-color);
        }
        .player-score-item-bottom strong {
            display: block;
            font-size: 1.0em;
            margin-bottom: 3px;
            color: var(--score-name-color);
        }
        .player-score-item-bottom span {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--score-text-color);
        }

        /* Scoring settings section */
        .scoring-settings {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-top: 25px;
        }
        .scoring-settings h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }
        .scoring-settings .difficulty-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .scoring-settings .point-input-group {
            display: flex;
            flex-direction: column;
        }
        .scoring-settings .point-input-group label {
            font-size: 0.95em;
            margin-bottom: 5px;
            font-weight: 400;
        }
        .scoring-settings .point-input-group input[type="number"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9em;
        }
        .scoring-settings .negative-scoring-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        .scoring-settings .negative-scoring-toggle input[type="checkbox"] {
            margin-left: 8px;
            transform: scale(1.3);
        }
        .scoring-settings .negative-scoring-toggle label {
            font-size: 1.0em;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>مسابقه بزرگ دانش</h1>
    </div>
    
    <div class="container">
        <div id="user-input-section" class="user-input">
            <h2>ثبت نام شرکت‌کنندگان</h2>
            <p>لطفاً نام حداقل ۲ و حداکثر ۱۰ شرکت‌کننده را وارد کنید:</p>
            <div id="player-inputs">
                </div>
            <button id="add-player-btn">افزودن شرکت‌کننده</button>
            <button id="start-quiz-btn" style="margin-top: 15px;">شروع مسابقه</button>
            
            <div class="save-load-buttons">
                <button id="load-game-btn">بارگذاری بازی</button>
            </div>

            <div class="scoring-settings">
                <h3>تنظیمات امتیازدهی</h3>
                <div class="difficulty-points">
                    <div class="point-input-group">
                        <label for="easy-correct-points">آسان (صحیح):</label>
                        <input type="number" id="easy-correct-points" value="1" min="0" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="easy-incorrect-points">آسان (غلط):</label>
                        <input type="number" id="easy-incorrect-points" value="-3" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="medium-correct-points">متوسط (صحیح):</label>
                        <input type="number" id="medium-correct-points" value="2" min="0" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="medium-incorrect-points">متوسط (غلط):</label>
                        <input type="number" id="medium-incorrect-points" value="-2" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="hard-correct-points">سخت (صحیح):</label>
                        <input type="number" id="hard-correct-points" value="3" min="0" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="hard-incorrect-points">سخت (غلط):</label>
                        <input type="number" id="hard-incorrect-points" value="-1" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="very-hard-correct-points">خیلی سخت (صحیح):</label>
                        <input type="number" id="very-hard-correct-points" value="4" min="0" step="0.5">
                    </div>
                    <div class="point-input-group">
                        <label for="very-hard-incorrect-points">خیلی سخت (غلط):</label>
                        <input type="number" id="very-hard-incorrect-points" value="-0.5" step="0.5">
                    </div>
                </div>
                <div class="negative-scoring-toggle">
                    <input type="checkbox" id="disable-negative-scoring">
                    <label for="disable-negative-scoring">غیرفعال کردن امتیاز منفی</label>
                </div>
            </div>
        </div>

        <div id="quiz-section">
            <div class="player-buttons-container" id="player-buttons-container">
                </div>
            
            <button id="next-question-btn">سوال بعدی</button>

            <div id="questions-container">
                </div>

            <div class="quiz-controls">
                <button id="fifty-fifty-btn">۵۰-۵۰ (حذف ۲ گزینه غلط)</button>
                <button id="tavakkol-btn">توکل به خدا (حذف ۱ گزینه غلط)</button>
                
                <label>دسته‌بندی‌های فعال:</label>
                <div id="category-multiselect" class="multiselect-container">
                    </div>

                <label>درجه سختی‌های فعال:</label>
                <div id="difficulty-multiselect" class="multiselect-container">
                    <label>
                        <input type="checkbox" name="difficulty" value="آسان" checked> آسان
                    </label>
                    <label>
                        <input type="checkbox" name="difficulty" value="متوسط" checked> متوسط
                    </label>
                    <label>
                        <input type="checkbox" name="difficulty" value="سخت" checked> سخت
                    </label>
                    <label>
                        <input type="checkbox" name="difficulty" value="خیلی سخت" checked> خیلی سخت
                    </label>
                </div>

                <button id="end-quiz-btn">پایان مسابقه</button>

                <div class="save-load-buttons">
                    <button id="save-game-btn">ذخیره بازی</button>
                </div>
            </div>
            <div id="player-scores-display-bottom">
                </div>
            <div id="total-questions-display" style="text-align: center; margin-top: 15px; font-size: 0.85em; color: var(--secondary-color);">
                </div>
        </div>

        <div id="results-section">
            <h2>نتایج مسابقه</h2>
            <ul id="results-list">
                </ul>
        </div>
    </div>

    <script>
        const playerInputsDiv = document.getElementById('player-inputs');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const userInputSection = document.getElementById('user-input-section');
        const quizSection = document.getElementById('quiz-section');
        const questionsContainer = document.getElementById('questions-container');
        const playerButtonsContainer = document.getElementById('player-buttons-container');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const endQuizBtn = document.getElementById('end-quiz-btn');
        const resultsSection = document.getElementById('results-section');
        const resultsList = document.getElementById('results-list');
        const categoryMultiselect = document.getElementById('category-multiselect');
        const difficultyMultiselect = document.getElementById('difficulty-multiselect');
        const fiftyFiftyBtn = document.getElementById('fifty-fifty-btn');
        const tavakkolBtn = document.getElementById('tavakkol-btn'); // دکمه جدید
        const playerScoresDisplayBottom = document.getElementById('player-scores-display-bottom');
        const saveGameBtn = document.getElementById('save-game-btn');
        const loadGameBtn = document.getElementById('load-game-btn');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');

        // Scoring settings elements
        const easyCorrectPointsInput = document.getElementById('easy-correct-points');
        const easyIncorrectPointsInput = document.getElementById('easy-incorrect-points');
        const mediumCorrectPointsInput = document.getElementById('medium-correct-points');
        const mediumIncorrectPointsInput = document.getElementById('medium-incorrect-points');
        const hardCorrectPointsInput = document.getElementById('hard-correct-points');
        const hardIncorrectPointsInput = document.getElementById('hard-incorrect-points');
        const veryHardCorrectPointsInput = document.getElementById('very-hard-correct-points');
        const veryHardIncorrectPointsInput = document.getElementById('very-hard-incorrect-points');
        const disableNegativeScoringCheckbox = document.getElementById('disable-negative-scoring');

        let playerCount = 0;
        const maxPlayers = 10;
        const minPlayers = 2;
        let allQuestions = [];
        let currentQuestion = null;
        let players = {};
        let playerNamesArray = [];
        let currentPlayerAutoIndex = 0;
        let manuallySelectedPlayer = null;
        let availableQuestionIndices = [];
        let categoryUsageCount = {}; // برای نمایش متعادل دسته بندی

        // Global scoring variables, updated from UI
        let currentDifficultyPointsCorrect = {};
        let currentDifficultyPointsIncorrect = {};
        let isNegativeScoringDisabled = false;


        // Helper function to convert English numbers to Farsi numbers
        function toFarsiNumber(n) {
            const farsiDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return n.toString().replace(/\d/g, x => farsiDigits[x]);
        }

        // --- Initialize scoring settings from UI ---
        function updateScoringSettings() {
            currentDifficultyPointsCorrect = {
                'آسان': parseFloat(easyCorrectPointsInput.value),
                'متوسط': parseFloat(mediumCorrectPointsInput.value),
                'سخت': parseFloat(hardCorrectPointsInput.value),
                'خیلی سخت': parseFloat(veryHardCorrectPointsInput.value)
            };
            currentDifficultyPointsIncorrect = {
                'آسان': parseFloat(easyIncorrectPointsInput.value),
                'متوسط': parseFloat(mediumIncorrectPointsInput.value),
                'سخت': parseFloat(hardIncorrectPointsInput.value),
                'خیلی سخت': parseFloat(veryHardIncorrectPointsInput.value)
            };
            isNegativeScoringDisabled = disableNegativeScoringCheckbox.checked;
        }

        // Initial update when script loads
        updateScoringSettings();

        // Add event listeners to update settings when changed
        easyCorrectPointsInput.addEventListener('change', updateScoringSettings);
        easyIncorrectPointsInput.addEventListener('change', updateScoringSettings);
        mediumCorrectPointsInput.addEventListener('change', updateScoringSettings);
        mediumIncorrectPointsInput.addEventListener('change', updateScoringSettings);
        hardCorrectPointsInput.addEventListener('change', updateScoringSettings);
        hardIncorrectPointsInput.addEventListener('change', updateScoringSettings);
        veryHardCorrectPointsInput.addEventListener('change', updateScoringSettings);
        veryHardIncorrectPointsInput.addEventListener('change', updateScoringSettings);
        disableNegativeScoringCheckbox.addEventListener('change', updateScoringSettings);


        // --- مدیریت ورود نام کاربران ---

        function addPlayerInput() {
            if (playerCount < maxPlayers) {
                playerCount++;
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'player-input-wrapper';
                inputWrapper.innerHTML = `
                    <label for="player${playerCount}">نام شرکت‌کننده ${toFarsiNumber(playerCount)}:</label>
                    <input type="text" id="player${playerCount}" required>
                `;
                playerInputsDiv.appendChild(inputWrapper);
            }
            if (playerCount >= maxPlayers) {
                addPlayerBtn.style.display = 'none';
            }
        }

        for (let i = 0; i < minPlayers; i++) {
            addPlayerInput();
        }

        addPlayerBtn.addEventListener('click', addPlayerInput);

        startQuizBtn.addEventListener('click', () => {
            playerNamesArray = [];
            let allInputsValid = true;
            for (let i = 1; i <= playerCount; i++) {
                const input = document.getElementById(`player${i}`);
                if (input && input.value.trim() === '') {
                    allInputsValid = false;
                    input.style.borderColor = 'red';
                } else if (input) {
                    playerNamesArray.push(input.value.trim());
                    input.style.borderColor = 'var(--border-color)';
                }
            }

            if (playerNamesArray.length < minPlayers) {
                alert(`لطفاً حداقل ${toFarsiNumber(minPlayers)} شرکت‌کننده وارد کنید.`);
                return;
            }

            if (!allInputsValid) {
                alert('لطفاً نام تمام شرکت‌کنندگان را وارد کنید.');
                return;
            }

            players = {};
            playerNamesArray.forEach(name => {
                // آبجکت بازیکنان با قابلیت‌های جدید
                players[name] = { score: 0, correct: 0, wrong: 0, fiftyFiftyUsed: 0, tavakkolUsed: 0 };
            });
            
            categoryUsageCount = {}; // ریست کردن شمارنده دسته‌بندی‌ها

            userInputSection.style.display = 'none';
            quizSection.style.display = 'block';
            loadQuestionsAndSetupQuiz(true); // Pass true to reset questions for new game
            updatePlayerScoresDisplay();
            populatePlayerButtons();
        });

        // --- مدیریت خواندن و نمایش سوالات ---

        async function loadQuestionsAndSetupQuiz(resetQuestions = false) {
            try {
                const response = await fetch('race.txt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                allQuestions = parseQuestions(text);
                
                totalQuestionsDisplay.textContent = `تعداد کل سوالات: ${toFarsiNumber(allQuestions.length)}`;
                populateCategoryFilter();

                if (resetQuestions) {
                    availableQuestionIndices = Array.from({ length: allQuestions.length }, (_, i) => i);
                }
                displayNextQuestion();
            } catch (error) {
                console.error("Error loading or parsing questions:", error);
                questionsContainer.innerHTML = "<p>خطا در بارگذاری سوالات. لطفاً از وجود فایل race.txt در کنار این فایل اطمینان حاصل کنید.</p>";
            }
        }

        function parseQuestions(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line !== '');
            const parsedQuestions = [];
            let currentQ = {};
            let parsingOptions = false;

            for (const line of lines) {
                if (line.startsWith('درجه سختی:')) {
                    if (Object.keys(currentQ).length > 0) {
                        parsedQuestions.push(currentQ);
                    }
                    currentQ = { options: [] };
                    currentQ.difficulty = line.replace('درجه سختی:', '').trim();
                    parsingOptions = false;
                } else if (line.startsWith('دسته بندی:')) {
                    currentQ.category = line.replace('دسته بندی:', '').trim();
                } else if (line.startsWith('سوال:')) {
                    currentQ.questionText = line.replace('سوال:', '').trim().replace(/^"|"$/g, '');
                    parsingOptions = false;
                } else if (line.startsWith('گزینه ها:')) {
                    parsingOptions = true;
                    currentQ.options = [];
                } else if (parsingOptions && (line.startsWith('الف)') || line.startsWith('ب)') || line.startsWith('ج)') || line.startsWith('د)'))) {
                    currentQ.options.push(line.trim());
                } else if (line.startsWith('جواب صحیح:')) {
                    currentQ.correctAnswer = line.replace('جواب صحیح:', '').trim();
                    parsingOptions = false;
                }
            }
            if (Object.keys(currentQ).length > 0) {
                parsedQuestions.push(currentQ);
            }
            return parsedQuestions;
        }

        function populateCategoryFilter() {
            const categories = new Set();
            categories.add('زبان انگلیسی'); 
            allQuestions.forEach(q => {
                if (q.category && q.category.trim() !== '') {
                    categories.add(q.category);
                }
            });
            categoryMultiselect.innerHTML = '';
            categories.forEach(cat => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="category" value="${cat}" checked> ${cat}`;
                categoryMultiselect.appendChild(label);
            });
        }

        function displayNextQuestion() {
            const activeCategories = Array.from(document.querySelectorAll('#category-multiselect input[name="category"]:checked')).map(cb => cb.value);
            const activeDifficulties = Array.from(document.querySelectorAll('#difficulty-multiselect input[name="difficulty"]:checked')).map(cb => cb.value);

            // 1. فیلتر سوالات موجود بر اساس درجه سختی و دسته‌بندی فعال
            let potentialIndices = availableQuestionIndices.filter(index => {
                const q = allQuestions[index];
                return activeDifficulties.includes(q.difficulty) && activeCategories.includes(q.category);
            });

            if (potentialIndices.length === 0) {
                questionsContainer.innerHTML = "<p>سوالی با این فیلترها پیدا نشد یا تمام سوالات پرسیده شده‌اند. لطفاً فیلترها را تغییر دهید یا بازی را ریست کنید.</p>";
                currentQuestion = null;
                updateHelperButtonsState();
                return;
            }

            // 2. گروه‌بندی سوالات باقی‌مانده بر اساس دسته‌بندی
            const questionsByCategory = {};
            potentialIndices.forEach(index => {
                const category = allQuestions[index].category;
                if (!questionsByCategory[category]) {
                    questionsByCategory[category] = [];
                }
                questionsByCategory[category].push(index);
            });
            
            const availableCategories = Object.keys(questionsByCategory);

            // 3. پیدا کردن کم‌استفاده‌ترین دسته‌بندی‌ها
            let minUsage = Infinity;
            availableCategories.forEach(cat => {
                minUsage = Math.min(minUsage, categoryUsageCount[cat] || 0);
            });
            
            const leastUsedCategories = availableCategories.filter(cat => (categoryUsageCount[cat] || 0) === minUsage);
            
            // 4. انتخاب یک دسته‌بندی تصادفی از بین کم‌استفاده‌ترین‌ها
            const selectedCategory = leastUsedCategories[Math.floor(Math.random() * leastUsedCategories.length)];
            
            // 5. افزایش شمارنده استفاده برای آن دسته‌بندی
            categoryUsageCount[selectedCategory] = (categoryUsageCount[selectedCategory] || 0) + 1;
            
            // 6. انتخاب یک سوال تصادفی از دسته‌بندی انتخاب‌شده
            const finalIndexPool = questionsByCategory[selectedCategory];
            const selectedQuestionIndex = finalIndexPool[Math.floor(Math.random() * finalIndexPool.length)];

            currentQuestion = allQuestions[selectedQuestionIndex];
            availableQuestionIndices = availableQuestionIndices.filter(index => index !== selectedQuestionIndex);

            questionsContainer.innerHTML = '';
            const questionBox = document.createElement('div');
            questionBox.className = 'question-box';
            questionBox.innerHTML = `
                <div class="question-meta">${currentQuestion.category} - ${currentQuestion.difficulty}</div>
                <div class="question-text">${currentQuestion.questionText}</div>
                <ul class="options-list" data-difficulty="${currentQuestion.difficulty}">
                    ${currentQuestion.options.map(option => `
                        <li data-option-text="${option.substring(option.indexOf(')') + 1).trim()}" data-option-key="${option.substring(0, option.indexOf(')'))}">${option}</li>
                    `).join('')}
                </ul>
            `;
            questionsContainer.appendChild(questionBox);

            document.querySelectorAll('.options-list li').forEach(li => li.addEventListener('click', handleOptionClick));
            
            manuallySelectedPlayer = null;
            updatePlayerButtons();
            updateHelperButtonsState();
        }

        function handleOptionClick(event) {
            const clickedOption = event.target;
            const optionsList = clickedOption.closest('.options-list');
            const questionDifficulty = optionsList.dataset.difficulty;

            let currentPlayerName = manuallySelectedPlayer || playerNamesArray[currentPlayerAutoIndex];

            if (!currentPlayerName) {
                alert('خطا: کاربر فعلی یافت نشد. لطفاً مسابقه را مجدداً شروع کنید.');
                return;
            }

            Array.from(optionsList.children).forEach(li => {
                li.classList.add('answered');
                li.removeEventListener('click', handleOptionClick);
            });
            
            let correctOptionElement = null;
            Array.from(optionsList.children).forEach(li => {
                if (currentQuestion && li.textContent.includes(currentQuestion.correctAnswer)) {
                    correctOptionElement = li;
                }
            });

            if (clickedOption === correctOptionElement) {
                clickedOption.classList.add('correct');
                players[currentPlayerName].correct++;
                players[currentPlayerName].score += currentDifficultyPointsCorrect[questionDifficulty];
            } else {
                clickedOption.classList.add('incorrect');
                players[currentPlayerName].wrong++;
                if (!isNegativeScoringDisabled) {
                    players[currentPlayerName].score += currentDifficultyPointsIncorrect[questionDifficulty];
                }
                if (correctOptionElement) {
                    correctOptionElement.classList.add('correct');
                }
            }
            updatePlayerScoresDisplay();
            updateHelperButtonsState(); // دکمه‌های کمکی بعد از پاسخ غیرفعال شوند
            
            if (!manuallySelectedPlayer) {
                currentPlayerAutoIndex = (currentPlayerAutoIndex + 1) % playerNamesArray.length;
            }
            updatePlayerButtons();
        }

        nextQuestionBtn.addEventListener('click', displayNextQuestion);
        endQuizBtn.addEventListener('click', showResults);
        fiftyFiftyBtn.addEventListener('click', handleFiftyFifty);
        tavakkolBtn.addEventListener('click', handleTavakkol); // اتصال رویداد
        
        // --- مدیریت امتیازات و انتخاب کاربر ---

        function updatePlayerScoresDisplay() {
            playerScoresDisplayBottom.innerHTML = '';
            playerNamesArray.forEach(name => {
                const player = players[name];
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-score-item-bottom';
                const scoreDisplay = (player.score % 1 !== 0) ? toFarsiNumber(player.score.toFixed(1)) : toFarsiNumber(player.score);
                playerDiv.innerHTML = `
                    <strong>${name}</strong><br>
                    <span>امتیاز: ${scoreDisplay}</span>
                `;
                playerScoresDisplayBottom.appendChild(playerDiv);
            });

            document.querySelectorAll('.player-button-wrapper').forEach(wrapper => {
                const playerName = wrapper.querySelector('.player-button').dataset.playerName;
                const scoreSpan = wrapper.querySelector('.player-score-top');
                if (players[playerName]) {
                    const scoreDisplay = (players[playerName].score % 1 !== 0) ? toFarsiNumber(players[playerName].score.toFixed(1)) : toFarsiNumber(players[playerName].score);
                    scoreSpan.textContent = `امتیاز: ${scoreDisplay}`;
                }
            });
        }

        function populatePlayerButtons() {
            playerButtonsContainer.innerHTML = '';
            playerNamesArray.forEach((name, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'player-button-wrapper';

                const scoreSpan = document.createElement('span');
                scoreSpan.className = 'player-score-top';
                scoreSpan.textContent = 'امتیاز: ۰';
                wrapper.appendChild(scoreSpan);

                const button = document.createElement('button');
                button.className = 'player-button';
                button.textContent = name;
                button.dataset.playerName = name;
                button.addEventListener('click', () => {
                    manuallySelectedPlayer = name;
                    updatePlayerButtons();
                    updateHelperButtonsState(); // وضعیت دکمه‌ها برای کاربر جدید آپدیت شود
                });
                wrapper.appendChild(button);
                playerButtonsContainer.appendChild(wrapper);
            });
            updatePlayerButtons();
            updatePlayerScoresDisplay();
        }

        function updatePlayerButtons() {
            document.querySelectorAll('.player-button').forEach(button => {
                button.classList.remove('active-player');
                const currentPlayerName = manuallySelectedPlayer || playerNamesArray[currentPlayerAutoIndex];
                if (button.dataset.playerName === currentPlayerName) {
                    button.classList.add('active-player');
                }
            });
        }

        // --- توابع کمکی ---

        function handleFiftyFifty() {
            if (!currentQuestion) return;
            let currentPlayerName = manuallySelectedPlayer || playerNamesArray[currentPlayerAutoIndex];
            const player = players[currentPlayerName];

            if (currentQuestion.difficulty !== 'سخت' && currentQuestion.difficulty !== 'خیلی سخت') {
                alert('قابلیت ۵۰-۵۰ فقط برای سوالات سخت و خیلی سخت است.');
                return;
            }
            if (player.fiftyFiftyUsed >= 2) {
                alert(`شما قبلاً ${toFarsiNumber(2)} بار از این امکان استفاده کرده‌اید.`);
                return;
            }

            player.fiftyFiftyUsed++;
            
            const optionsList = questionsContainer.querySelector('.options-list');
            const incorrectOptions = Array.from(optionsList.children).filter(li => !li.textContent.includes(currentQuestion.correctAnswer));
            
            for (let i = 0; i < 2; i++) {
                if (incorrectOptions.length > 0) {
                    const randomIndex = Math.floor(Math.random() * incorrectOptions.length);
                    incorrectOptions.splice(randomIndex, 1)[0].classList.add('removed');
                }
            }
            updateHelperButtonsState();
        }

        function handleTavakkol() {
            if (!currentQuestion) return;
            let currentPlayerName = manuallySelectedPlayer || playerNamesArray[currentPlayerAutoIndex];
            const player = players[currentPlayerName];

            if (player.tavakkolUsed >= 2) {
                alert(`شما قبلاً ${toFarsiNumber(2)} بار از گزینه "توکل به خدا" استفاده کرده‌اید.`);
                return;
            }
            
            player.tavakkolUsed++;
            
            const optionsList = questionsContainer.querySelector('.options-list');
            const incorrectOptions = Array.from(optionsList.children)
                .filter(li => !li.textContent.includes(currentQuestion.correctAnswer) && !li.classList.contains('removed'));

            if (incorrectOptions.length > 0) {
                const optionToRemove = incorrectOptions[Math.floor(Math.random() * incorrectOptions.length)];
                optionToRemove.classList.add('removed');
            }
            updateHelperButtonsState();
        }

        function updateHelperButtonsState() {
            if (!currentQuestion) {
                fiftyFiftyBtn.disabled = true;
                tavakkolBtn.disabled = true;
                return;
            }

            const currentPlayerName = manuallySelectedPlayer || playerNamesArray[currentPlayerAutoIndex];
            const player = players[currentPlayerName];
            const isAnswered = questionsContainer.querySelector('.options-list .answered');

            // 50-50 Button State
            const canUseFiftyFifty = currentQuestion.difficulty === 'سخت' || currentQuestion.difficulty === 'خیلی سخت';
            fiftyFiftyBtn.disabled = player.fiftyFiftyUsed >= 2 || !canUseFiftyFifty || isAnswered;

            // Tavakkol Button State
            tavakkolBtn.disabled = player.tavakkolUsed >= 2 || isAnswered;
            
            // Disable both if any option is already removed (to prevent using both on one question)
            const isAnyOptionRemoved = questionsContainer.querySelector('.options-list .removed');
            if(isAnyOptionRemoved){
                fiftyFiftyBtn.disabled = true;
                tavakkolBtn.disabled = true;
            }
        }


        // --- نمایش نتایج نهایی ---
        function showResults() {
            quizSection.style.display = 'none';
            resultsSection.style.display = 'block';
            resultsList.innerHTML = '';

            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);

            sortedPlayers.forEach(([name, data]) => {
                const listItem = document.createElement('li');
                const scoreDisplay = (data.score % 1 !== 0) ? toFarsiNumber(data.score.toFixed(1)) : toFarsiNumber(data.score);
                listItem.innerHTML = `
                    <strong>${name}:</strong>
                    <br> امتیاز کلی: ${scoreDisplay}
                    <br> پاسخ صحیح: ${toFarsiNumber(data.correct)}
                    <br> پاسخ غلط: ${toFarsiNumber(data.wrong)}
                    <br> دفعات استفاده از ۵۰-۵۰: ${toFarsiNumber(data.fiftyFiftyUsed)}
                    <br> دفعات استفاده از توکل به خدا: ${toFarsiNumber(data.tavakkolUsed)}
                `;
                resultsList.appendChild(listItem);
            });
        }

        // --- قابلیت ذخیره و بارگذاری بازی ---
        saveGameBtn.addEventListener('click', () => {
            const defaultFileName = `مسابقه_دانش_${new Date().toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-')}.txt`;
            const fileName = prompt("لطفاً نامی برای فایل ذخیره وارد کنید:", defaultFileName);
            if (fileName === null || fileName.trim() === "") {
                alert("عملیات ذخیره سازی لغو شد.");
                return;
            }
            const finalFileName = fileName.endsWith('.txt') ? fileName : `${fileName}.txt`;

            const gameState = {
                players: players,
                playerNamesArray: playerNamesArray,
                currentPlayerAutoIndex: currentPlayerAutoIndex,
                availableQuestionIndices: availableQuestionIndices,
                categoryUsageCount: categoryUsageCount, // ذخیره شمارنده دسته‌بندی
                activeCategories: Array.from(document.querySelectorAll('#category-multiselect input[name="category"]:checked')).map(checkbox => checkbox.value),
                activeDifficulties: Array.from(document.querySelectorAll('#difficulty-multiselect input[name="difficulty"]:checked')).map(checkbox => checkbox.value),
                scoring: {
                    correct: currentDifficultyPointsCorrect,
                    incorrect: currentDifficultyPointsIncorrect,
                    disableNegative: isNegativeScoringDisabled
                }
            };
            
            const dataStr = JSON.stringify(gameState, null, 2);
            const blob = new Blob([dataStr], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = finalFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`بازی با موفقیت در فایل ${finalFileName} ذخیره شد!`);
        });

        loadGameBtn.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.txt';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const savedState = event.target.result;
                        const gameState = JSON.parse(savedState);
                        
                        // بازگردانی داده‌های بازیکنان با مقادیر پیش‌فرض برای سازگاری
                        playerNamesArray = gameState.playerNamesArray;
                        players = {};
                        playerNamesArray.forEach(name => {
                            const pData = gameState.players[name];
                            players[name] = {
                                score: pData.score || 0,
                                correct: pData.correct || 0,
                                wrong: pData.wrong || 0,
                                fiftyFiftyUsed: pData.fiftyFiftyUsed || 0,
                                tavakkolUsed: pData.tavakkolUsed || 0,
                            };
                        });
                        
                        currentPlayerAutoIndex = gameState.currentPlayerAutoIndex || 0;
                        availableQuestionIndices = gameState.availableQuestionIndices;
                        categoryUsageCount = gameState.categoryUsageCount || {}; // بارگذاری شمارنده

                        // Restore filter states
                        if (gameState.activeCategories) {
                             document.querySelectorAll('#category-multiselect input[name="category"]').forEach(cb => {
                                cb.checked = gameState.activeCategories.includes(cb.value);
                            });
                        }
                        if (gameState.activeDifficulties) {
                            document.querySelectorAll('#difficulty-multiselect input[name="difficulty"]').forEach(cb => {
                                cb.checked = gameState.activeDifficulties.includes(cb.value);
                            });
                        }
                        
                        // Restore scoring settings
                        if (gameState.scoring) {
                            easyCorrectPointsInput.value = gameState.scoring.correct['آسان'];
                            easyIncorrectPointsInput.value = gameState.scoring.incorrect['آسان'];
                            mediumCorrectPointsInput.value = gameState.scoring.correct['متوسط'];
                            mediumIncorrectPointsInput.value = gameState.scoring.incorrect['متوسط'];
                            hardCorrectPointsInput.value = gameState.scoring.correct['سخت'];
                            hardIncorrectPointsInput.value = gameState.scoring.incorrect['سخت'];
                            veryHardCorrectPointsInput.value = gameState.scoring.correct['خیلی سخت'];
                            veryHardIncorrectPointsInput.value = gameState.scoring.incorrect['خیلی سخت'];
                            disableNegativeScoringCheckbox.checked = gameState.scoring.disableNegative;
                            updateScoringSettings();
                        }
                        
                        // Update player input fields
                        playerInputsDiv.innerHTML = '';
                        playerCount = 0;
                        gameState.playerNamesArray.forEach(name => {
                            addPlayerInput();
                            document.getElementById(`player${playerCount}`).value = name;
                        });

                        // Switch view
                        userInputSection.style.display = 'none';
                        quizSection.style.display = 'block';

                        loadQuestionsAndSetupQuiz(false).then(() => {
                            populatePlayerButtons();
                            updatePlayerScoresDisplay();
                            alert('بازی با موفقیت بارگذاری شد!');
                        });

                    } catch (err) {
                        alert('خطا در بارگذاری بازی: فرمت فایل صحیح نیست.' + err);
                        console.error("Error parsing saved game file:", err);
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        });

    </script>
</body>
</html>
