<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقه دانش</title>
    <style>
        body {
            font-family: 'B Nazanin', Arial, sans-serif; /* می‌توانید فونت مناسب‌تری اضافه کنید */
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .user-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .user-input input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .user-input button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        .user-input button:hover {
            background-color: #0056b3;
        }
        #quiz-section {
            display: none; /* در ابتدا مخفی است */
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }
        .question-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .question-meta {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
            text-align: left; /* برای نمایش در سمت چپ */
        }
        .question-text {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options-list li {
            background-color: #e9e9e9;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid #ddd;
        }
        .options-list li:hover {
            background-color: #dcdcdc;
            transform: translateY(-2px);
        }
        .options-list li.correct {
            background-color: #d4edda; /* Light green */
            border-color: #28a745; /* Darker green */
            color: #155724;
        }
        .options-list li.incorrect {
            background-color: #f8d7da; /* Light red */
            border-color: #dc3545; /* Darker red */
            color: #721c24;
        }
        .options-list li.disabled {
            pointer-events: none; /* Disable clicking after an answer */
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>مسابقه بزرگ دانش</h1>
        <div id="user-input-section" class="user-input">
            <h2>ثبت نام شرکت‌کنندگان</h2>
            <p>لطفاً نام حداقل ۲ و حداکثر ۱۰ شرکت‌کننده را وارد کنید:</p>
            <div id="player-inputs">
                </div>
            <button id="add-player-btn">افزودن شرکت‌کننده</button>
            <button id="start-quiz-btn" style="margin-top: 15px;">شروع مسابقه</button>
        </div>

        <div id="quiz-section">
            <h2>سوالات</h2>
            <div id="questions-container">
                </div>
        </div>
    </div>

    <script>
        const playerInputsDiv = document.getElementById('player-inputs');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const userInputSection = document.getElementById('user-input-section');
        const quizSection = document.getElementById('quiz-section');
        const questionsContainer = document.getElementById('questions-container');

        let playerCount = 0;
        const maxPlayers = 10;
        const minPlayers = 2;
        let questions = []; // To store parsed questions

        // --- مدیریت ورود نام کاربران ---

        function addPlayerInput() {
            if (playerCount < maxPlayers) {
                playerCount++;
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'player-input-wrapper';
                inputWrapper.innerHTML = `
                    <label for="player${playerCount}">نام شرکت‌کننده ${playerCount}:</label>
                    <input type="text" id="player${playerCount}" placeholder="نام خود را وارد کنید" required>
                `;
                playerInputsDiv.appendChild(inputWrapper);
            }
            if (playerCount >= maxPlayers) {
                addPlayerBtn.style.display = 'none'; // Hide add button if max players reached
            }
        }

        // Add initial players (e.g., 2 by default)
        for (let i = 0; i < minPlayers; i++) {
            addPlayerInput();
        }

        addPlayerBtn.addEventListener('click', addPlayerInput);

        startQuizBtn.addEventListener('click', () => {
            const playerNames = [];
            let allInputsValid = true;
            for (let i = 1; i <= playerCount; i++) {
                const input = document.getElementById(`player${i}`);
                if (input && input.value.trim() === '') {
                    allInputsValid = false;
                    input.style.borderColor = 'red'; // Highlight empty input
                } else if (input) {
                    playerNames.push(input.value.trim());
                    input.style.borderColor = '#ddd'; // Reset border color
                }
            }

            if (playerNames.length < minPlayers) {
                alert(`لطفاً حداقل ${minPlayers} شرکت‌کننده وارد کنید.`);
                return;
            }

            if (!allInputsValid) {
                alert('لطفاً نام تمام شرکت‌کنندگان را وارد کنید.');
                return;
            }

            // At this point, playerNames array contains valid names
            console.log('Registered Players:', playerNames);

            userInputSection.style.display = 'none';
            quizSection.style.display = 'block';
            loadQuestions(); // Start loading and displaying questions
        });


        // --- مدیریت خواندن و نمایش سوالات ---

        async function loadQuestions() {
            try {
                const response = await fetch('race.txt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                questions = parseQuestions(text);
                displayQuestions();
            } catch (error) {
                console.error("Error loading or parsing questions:", error);
                questionsContainer.innerHTML = "<p>خطا در بارگذاری سوالات. لطفاً از وجود فایل race.txt در کنار این فایل اطمینان حاصل کنید.</p>";
            }
        }

        function parseQuestions(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line !== '');
            const parsedQuestions = [];
            let currentQuestion = {};
            let parsingOptions = false;

            for (const line of lines) {
                if (line.startsWith('درجه سختی:')) {
                    if (Object.keys(currentQuestion).length > 0) {
                        parsedQuestions.push(currentQuestion);
                    }
                    currentQuestion = { options: [] };
                    currentQuestion.difficulty = line.replace('درجه سختی:', '').trim();
                    parsingOptions = false;
                } else if (line.startsWith('دسته بندی:')) {
                    currentQuestion.category = line.replace('دسته بندی:', '').trim();
                } else if (line.startsWith('سوال:')) {
                    currentQuestion.questionText = line.replace('سوال:', '').trim().replace(/^"|"$/g, ''); // Remove quotes
                    parsingOptions = false;
                } else if (line.startsWith('گزینه ها:')) {
                    parsingOptions = true;
                    currentQuestion.options = [];
                } else if (parsingOptions && (line.startsWith('الف)') || line.startsWith('ب)') || line.startsWith('ج)') || line.startsWith('د)'))) {
                    currentQuestion.options.push(line.trim());
                } else if (line.startsWith('جواب صحیح:')) {
                    currentQuestion.correctAnswer = line.replace('جواب صحیح:', '').trim();
                    parsingOptions = false; // Options parsing finished for this question
                }
            }
            if (Object.keys(currentQuestion).length > 0) {
                parsedQuestions.push(currentQuestion);
            }
            return parsedQuestions;
        }


        function displayQuestions() {
            questionsContainer.innerHTML = ''; // Clear previous questions
            questions.forEach((q, index) => {
                const questionBox = document.createElement('div');
                questionBox.className = 'question-box';
                questionBox.innerHTML = `
                    <div class="question-meta">
                        ${q.category} - ${q.difficulty}
                    </div>
                    <div class="question-text">
                        ${index + 1}. ${q.questionText}
                    </div>
                    <ul class="options-list" data-correct-answer="${q.correctAnswer}">
                        ${q.options.map(option => `
                            <li data-option="${option.substring(0, option.indexOf(')'))}">${option}</li>
                        `).join('')}
                    </ul>
                `;
                questionsContainer.appendChild(questionBox);
            });

            // Add event listeners to options
            document.querySelectorAll('.options-list li').forEach(optionLi => {
                optionLi.addEventListener('click', handleOptionClick);
            });
        }

        function handleOptionClick(event) {
            const clickedOption = event.target;
            const optionsList = clickedOption.closest('.options-list');
            const correctAnswerText = optionsList.dataset.correctAnswer; // e.g., "انگلیس"

            // Disable all options for this question after one is clicked
            Array.from(optionsList.children).forEach(li => {
                li.classList.add('disabled');
                li.removeEventListener('click', handleOptionClick); // Remove listener to prevent re-clicking
            });

            // Find the correct option based on its text content
            let correctOptionElement = null;
            Array.from(optionsList.children).forEach(li => {
                // We need to find the li that contains the `correctAnswerText`
                // Let's assume the correct answer text is part of the option string, e.g., "ج) انگلیس"
                if (li.textContent.includes(correctAnswerText)) {
                    correctOptionElement = li;
                }
            });
            
            // Check if the clicked option is the correct one
            if (clickedOption === correctOptionElement) {
                clickedOption.classList.add('correct');
            } else {
                clickedOption.classList.add('incorrect');
                if (correctOptionElement) {
                    correctOptionElement.classList.add('correct'); // Show the correct answer as well
                }
            }
        }

    </script>
</body>
</html>
